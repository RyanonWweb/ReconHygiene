---
import SiteLayout from '../../layouts/SiteLayout.astro';
import { getCollection, render } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
  const hunts = await getCollection('hunts', ({ data }) => !data.draft);
  return hunts.map(hunt => ({ params: { slug: hunt.id.replace(/\.mdx?$/, '') }, props: { hunt } }));
}) satisfies GetStaticPaths;

const { hunt } = Astro.props;
const { title, date, summary, tactic, technique, severity, tags, labType, dataSources, tools, output } = hunt.data;
const { Content } = await render(hunt);

const severityMap: Record<string, string> = {
  low: 'badge-green', medium: 'badge-yellow', high: 'badge-red', critical: 'badge-critical'
};
const labTypeConfig = {
  'lab-simulation': { label: 'Lab Simulation', css: 'lab-badge-sim', icon: 'üß™' },
  'production-pattern': { label: 'Production Pattern', css: 'lab-badge-prod', icon: 'üè≠' },
};
const ltc = labTypeConfig[labType] ?? labTypeConfig['lab-simulation'];
const formattedDate = new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
---

<SiteLayout title={title} description={summary}>
  <div class="page-header">
    <div class="container">
      <div class="breadcrumb"><a href="/">Home</a> / <a href="/hunts">Hunts</a> / {title}</div>
      <div class="hunt-meta-top">
        <span class={`lab-badge ${ltc.css}`}>{ltc.icon} {ltc.label}</span>
        <span class={`badge ${severityMap[severity] ?? 'badge-gray'}`}>{severity}</span>
        <span class="tag">{tactic}</span>
        <span class="tag">{technique}</span>
        {tags.map(t => <span class="tag">{t}</span>)}
      </div>
      <h1 class="page-title" style="font-size:2rem">{title}</h1>
      <p class="page-sub">{summary}</p>
      <time class="hunt-date" datetime={date.toISOString()}>{formattedDate}</time>
    </div>
  </div>

  <!-- Telemetry block -->
  {(dataSources.length > 0 || tools.length > 0) && (
    <div class="telemetry-bar">
      <div class="container telemetry-inner">
        {dataSources.length > 0 && (
          <div class="telem-group">
            <span class="telem-label">Data Sources</span>
            <div class="telem-tags">
              {dataSources.map((s: string) => <span class="telem-tag">{s}</span>)}
            </div>
          </div>
        )}
        {tools.length > 0 && (
          <div class="telem-group">
            <span class="telem-label">Tools</span>
            <div class="telem-tags">
              {tools.map((t: string) => <span class="telem-tag telem-tag-tool">{t}</span>)}
            </div>
          </div>
        )}
        {output && (
          <div class="telem-group">
            <span class="telem-label">Output</span>
            <span class="telem-tag telem-tag-output">{output}</span>
          </div>
        )}
      </div>
    </div>
  )}

  <div class="container article-container">
    <article class="prose-dark">
      <Content />
    </article>
    <aside class="hunt-sidebar">
      <div class="sidebar-card glass">
        <h4 class="sidebar-title">Hunt Details</h4>
        <dl class="sidebar-dl">
          <dt>Tactic</dt><dd>{tactic}</dd>
          <dt>Technique</dt><dd>{technique}</dd>
          <dt>Severity</dt><dd><span class={`badge ${severityMap[severity] ?? 'badge-gray'}`}>{severity}</span></dd>
          <dt>Type</dt><dd><span class={`lab-badge-sm ${ltc.css}`}>{ltc.icon} {ltc.label}</span></dd>
          <dt>Published</dt><dd>{formattedDate}</dd>
        </dl>
      </div>

      {dataSources.length > 0 && (
        <div class="sidebar-card glass">
          <h4 class="sidebar-title">Telemetry Used</h4>
          <div class="sidebar-telem">
            {dataSources.map((s: string) => <span class="tag">{s}</span>)}
          </div>
          {tools.length > 0 && (
            <>
              <h4 class="sidebar-title" style="margin-top:0.875rem">Tools</h4>
              <div class="sidebar-telem">
                {tools.map((t: string) => <span class="tag">{t}</span>)}
              </div>
            </>
          )}
        </div>
      )}

      <div class="sidebar-card glass">
        <h4 class="sidebar-title">Tags</h4>
        <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.5rem">
          {tags.map(t => <span class="tag">{t}</span>)}
        </div>
      </div>
      <a href="/hunts" class="btn btn-ghost" style="width:100%;justify-content:center">‚Üê All Hunt Reports</a>
    </aside>
  </div>
</SiteLayout>

<style>
  .page-header { border-bottom: 1px solid var(--border); background: var(--surface); padding: 3.5rem 0 2rem; }
  .breadcrumb { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }
  .breadcrumb a { color: var(--text-muted); }
  .breadcrumb a:hover { color: var(--cyan); }
  .hunt-meta-top { display: flex; flex-wrap: wrap; align-items: center; gap: 0.4rem; margin-bottom: 1rem; }
  .page-title { font-size: 2rem; margin: 0 0 0.75rem; }
  .page-sub { color: var(--text-muted); font-size: 0.95rem; margin: 0 0 0.75rem; max-width: 65ch; }
  .hunt-date { font-size: 0.8rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

  /* Lab/Production badge */
  .lab-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 4px;
    font-size: 0.72rem;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .lab-badge-sm {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.68rem;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
  }
  .lab-badge-sim {
    background: rgba(100,116,139,0.12);
    color: #94a3b8;
    border: 1px solid rgba(100,116,139,0.25);
  }
  .lab-badge-prod {
    background: rgba(34,197,94,0.1);
    color: #22c55e;
    border: 1px solid rgba(34,197,94,0.25);
  }

  /* Telemetry bar */
  .telemetry-bar {
    background: var(--surface-2);
    border-bottom: 1px solid var(--border);
  }
  .telemetry-inner {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding: 1rem 1.5rem;
    align-items: flex-start;
  }
  .telem-group { display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap; }
  .telem-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    white-space: nowrap;
    font-family: 'JetBrains Mono', monospace;
  }
  .telem-tags { display: flex; flex-wrap: wrap; gap: 0.35rem; }
  .telem-tag {
    padding: 2px 8px;
    background: rgba(30,30,46,0.8);
    border: 1px solid var(--border-2);
    border-radius: 4px;
    font-size: 0.72rem;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-dim);
  }
  .telem-tag-tool { border-color: rgba(0,212,255,0.2); color: var(--cyan); background: var(--cyan-dim); }
  .telem-tag-output { border-color: rgba(110,64,201,0.25); color: #a78bfa; background: rgba(110,64,201,0.1); }

  /* Article layout */
  .article-container {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 3rem;
    padding-top: 3rem;
    padding-bottom: 4rem;
    align-items: start;
  }
  .hunt-sidebar { position: sticky; top: 80px; display: flex; flex-direction: column; gap: 1rem; }
  .sidebar-card { padding: 1.25rem; }
  .sidebar-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin: 0 0 0.875rem; }
  .sidebar-dl { margin: 0; display: grid; grid-template-columns: auto 1fr; gap: 0.4rem 0.75rem; }
  .sidebar-dl dt { font-size: 0.78rem; color: var(--text-muted); font-weight: 500; }
  .sidebar-dl dd { font-size: 0.78rem; color: var(--text-dim); margin: 0; }
  .sidebar-telem { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.4rem; }
  @media (max-width: 900px) { .article-container { grid-template-columns: 1fr; } .hunt-sidebar { position: static; } }
</style>
